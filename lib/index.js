!function(e,t){for(var s in t)e[s]=t[s]}(this,function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=3)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(1);!function(e){e[e.none=0]="none",e[e.bearer=1]="bearer",e[e.aws4=2]="aws4"}(t.AuthType||(t.AuthType={}));t.FirestoreTimestamp=class extends i.firestore.Timestamp{};t.FirestoreWriteResult=class{},function(e){e[e.none=0]="none",e[e.id=1]="id",e[e.string=2]="string",e[e.boolean=3]="boolean",e[e.bytes=4]="bytes",e[e.geopoint=5]="geopoint",e[e.number=6]="number",e[e.date=7]="date",e[e.array=8]="array",e[e.null=9]="null",e[e.object=10]="object"}(t.ModelFieldType||(t.ModelFieldType={}))},function(e,t){e.exports=require("firebase-admin")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(21),r=s(22),o=s(23),n=s(24);t.FirebaseConfig=class{constructor(e){this.host="firebaseremoteconfig.googleapis.com",this.scopes=["https://www.googleapis.com/auth/firebase.remoteconfig"],this.cacheConfig=null,this.projectId=null,this.keyFileName=null,this.path=null,this._cache=null,this._etag=null,Object.assign(this,e),this.path=`/v1/projects/${this.projectId}/remoteConfig`,this._cache=new n(this.cacheConfig||{})}getETag(){return this._etag||(this._etag=this._cache.get("--firebase-config-etag--")||null),this._etag}setETag(e){e!==this._etag&&(this._etag=e,this._cache.set("--firebase-config-etag--",this._etag))}getAccessToken(){return new Promise((e,t)=>{const s=JSON.parse(i.readFileSync(this.keyFileName,"utf8"));new o.google.auth.JWT(s.client_email,null,s.private_key,this.scopes,null).authorize((s,i)=>{s?t(s):e(i.access_token)})})}get(e){return new Promise((t,s)=>{this.getAccessToken().then(i=>{r.default(`https://${this.host}${this.path}${e?`?version_number=${e}`:""}`,{headers:{Authorization:`Bearer ${i}`,"Accept-Encoding":"gzip"}}).then(e=>(this.setETag(e.headers.etag),e.json())).then(e=>t(e)).catch(e=>s(e))},e=>s(e))})}set(e){return new Promise((t,s)=>{this.getAccessToken().then(i=>{const o={Authorization:`Bearer ${i}`,"Content-Type":"application/json; UTF-8","Accept-Encoding":"gzip"},n=this.getETag();n&&(o["If-Match"]=n),r.default(`https://${this.host}${this.path}`,{method:"PUT",headers:o,body:e}).then(e=>{console.log(e),t()}).catch(e=>s(e))},e=>s(e))})}}},function(e,t,s){"use strict";function i(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),i(s(4)),i(s(0)),i(s(5)),i(s(30)),i(s(2))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i{constructor(e){this.request=null,this.response=null,this.init(e)}init(e){setTimeout(()=>{Object.assign(this,e)},0)}all(){this.response.sendStatus(405)}sendError(e){const t=i.getCodeFromError(e),s=i.getBodyFromError(e);s?(this.response.status(t),"string"==typeof s?this.response.send(s):this.response.json(s)):this.response.sendStatus(t)}static getCodeFromError(e){return"string"==typeof e?500:(e.error||e).code||500}static getBodyFromError(e){if("string"==typeof e)return e;const t=e.error||e;return t.code&&delete t.code,t.message||Object.keys(t).length?t:null}}t.Component=i},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(6),r=s(7);t.firebaseApp=(e=>i.https.onRequest(r.expressApp(e)))},function(e,t){e.exports=require("firebase-functions")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(8),r=s(9),o=s(10),n=s(11),a=s(12),c=s(13),l=s(14),u=s(15),h=s(16);t.expressApp=(e=>{const t=i();return t.config=e,e.helmet&&t.use(r(e.helmet)),e.session&&t.use(o(e.session)),e.cors&&t.use(n(e.cors)),e.cookieParser&&e.cookieParser.secret&&t.use(a(e.cookieParser.secret,e.cookieParser.options)),e.bodyParser&&(e.bodyParser.raw&&t.use(c.raw(e.bodyParser.raw)),e.bodyParser.json&&t.use(c.json(e.bodyParser.json)),e.bodyParser.text&&t.use(c.text(e.bodyParser.text)),e.bodyParser.urlencoded&&t.use(c.urlencoded(e.bodyParser.urlencoded))),e.sanitizer&&(t.use(u(e.sanitizer)),t.use(h.sanitize)),e.firebase&&t.use(h.firebase(e.firebase)),e.models&&t.use(h.models(e.models)),e.routes&&t.use(h.routes({routes:e.routes,authType:e.authType})),e.viewsPath&&(t.set("views",e.viewsPath),t.set("view engine","ejs"),t.engine(e.viewsExtension||"html",l.renderFile)),t})},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("ejs")},function(e,t){e.exports=require("express-sanitizer")},function(e,t,s){"use strict";function i(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),i(s(17)),i(s(18)),i(s(19)),i(s(29))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(1);let r=null,o=null;t.firebase=(e=>(t,s,n)=>{if((!r||!o)&&e){const t={},s={timestampsInSnapshots:e.timestampsInSnapshots};e.projectId&&(t.projectId=e.projectId,s.projectId=e.projectId),e.keyFileName&&(t.credential=i.credential.cert(e.keyFileName),s.keyFilename=e.keyFileName),e.databaseAuthVariableOverride&&(t.databaseAuthVariableOverride=e.databaseAuthVariableOverride),e.databaseURL&&(t.databaseURL=e.databaseURL),e.serviceAccountId&&(t.serviceAccountId=e.serviceAccountId),e.storageBucket&&(t.storageBucket=e.storageBucket),r||(r=i.initializeApp(t)||null),o||(o=r&&r.firestore()||null)&&o.settings(s)}t.firebaseApp=r,t.firestore=o,n()})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i={};t.models=(e=>(t,s,r)=>{if(!Object.keys(i).length&&e&&Object.keys(e).length)for(const r in e)i[r]=e[r],i[r].modelName=r,i[r].request=t,i[r].response=s,i[r].firestore=t.firestore;t.models=i,r()})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(20),r=["get","post","put","head","delete","options","trace","copy","lock","mkcol","move","purge","propfind","proppatch","unlock","report","mkactivity","checkout","merge","m-search","notify","subscribe","unsubscribe","patch","search","connect","all"];t.routes=(e=>(t,s,o)=>{const n=e.routes||[];for(let o=0,a=n.length;o<a;o++){const a=n[o],c=new a.component({request:t,response:s,firestore:t.firestore});for(let s=0,o=r.length;s<o;s++){const o=r[s],n=c[o];t.app[o]&&n&&t.app[o](a.path,(t,s,r)=>{t.authType=void 0===a.authType?e.authType:a.authType,i.validateHeaders(t)?(c.init({request:t,response:s}),setTimeout(()=>{n.call(c,r)},0)):s.sendStatus(403)})}}o()})},function(e,t,s){"use strict";function i(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),i(s(2)),i(s(25))},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("googleapis")},function(e,t){e.exports=require("node-cache")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(0),r=s(26),o=s(27);t.validateHeaders=(e=>{let t=!e.authType;if(e.authType)switch(e.authType){case i.AuthType.bearer:t=r.validateBearer(e);break;case i.AuthType.aws4:t=o.validateAWS4(e)}return t})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateBearer=(e=>{const t=e.headers.authorization;if(t.startsWith("Bearer ")){const e=t.split("Bearer ")[1];return console.log(e),!0}return!1})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(28);t.validateAWS4=(e=>{const t=e.app.config;if(t&&t.aws&&t.aws.appSync){const s=t.aws.appSync.authHeaderName?e.headers[t.aws.appSync.authHeaderName]||"":e.headers.authorization||"";return i.AWS4.validateAuthorizationHeader(s,i.AWS4.getAmzDate(e.headers),"",t.aws.appSync.accessKeyId,t.aws.appSync.region)}return!1})},function(e,t){e.exports=require("@inpassor/functions")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sanitize=((e,t,s)=>{if(e.sanitize){const t=t=>{for(const s in e[t])e[t].hasOwnProperty(s)&&"string"==typeof e[t][s]&&(e[t][s]=e.sanitize(e[t][s]))};for(const e of["query","params","body"])t(e)}s()})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(1),r=s(0);class o{constructor(e){return this.modelName="",this.request=null,this.response=null,this.firestore=null,this.collection="",this.schema={},this.collectionReference=null,this.documentReference=null,this.exists=!0,this.createTime=null,this.updateTime=null,this.readTime=null,this._idSchema=null,this._schema={},this._fieldNames=null,this._data={},this._writeResult=null,this.init(e),new Proxy(this,this)}init(e){setTimeout(()=>{Object.assign(this,e),this.modelName||(this.modelName=this.constructor.name),this._normalizeSchema(),this.firestore&&this.collection&&(this.collectionReference=this.firestore.collection(this.collection))},0)}get fieldNames(){return this._fieldNames||(this._fieldNames=this._schema&&Object.keys(this._schema)||[]),this._fieldNames}set(e,t,s){if(e.hasOwnProperty(t))return e[t]=s,!0;return!(-1===e.fieldNames.indexOf(t)||!e.setValue)&&e.setValue(t,s)}setValue(e,t){if(t){const s=this._schema[e];if(s&&(!s.validate||s.validate&&s.validate(t)))return!(s.set&&!s.set(t))&&(this._data[e]=t,!0)}return!1}setValues(e){if(e&&Object.keys(e).length){for(const t in e)if(e.hasOwnProperty(t)&&!this.setValue(t,e[t]))return!1;return!0}return!1}get(e,t){if(void 0!==e[t])return e[t];return-1!==(e.fieldNames||[]).indexOf(t)&&e.getValue?e.getValue(t):void 0}getValue(e){const t=this._schema[e];if(t)return t.get?t.get():this._data[e]||void 0}getValues(e){const t={},s=e&&e.length?e:this.fieldNames;for(const e of s)t[e]=this.getValue(e)||null;return t}getValuesForUpdate(){const e={};if(this._idSchema){const t=this._idSchema.key;for(const s of this.fieldNames)if(s!==t){const t=this.getValue(s);void 0!==t&&(e[s]=t)}}return e}setId(e){const t=this._idSchema&&this._idSchema.key;if(t){const s=this.getValue(t);return console.log(s),console.log(e),this.setValue(t,e)}return!1}getId(){if(this._idSchema){const e=this.getValue(this._idSchema.key);if(!e)throw new Error(`The field "${this._idSchema.key}" of the model "${this.modelName}" is undefined`);return e}throw new Error(`The Schema of the model "${this.modelName}" has no field of the type ID`)}removeField(e){return!!this._schema[e]&&(this._data[e]=i.firestore.FieldValue.delete(),!0)}update(e){return new Promise((t,s)=>{this.documentReference?!e||e&&this.setValues(e)?this.documentReference.update(this.getValuesForUpdate()).then(e=>{t(this._normalizeWriteResult(e))},e=>s(e)):s(`Cannot update values for the model "${this.modelName}"`):s(`Cannot update the model "${this.modelName}"`)})}setFromSnapshot(e){return this.exists=!!e&&!!e.exists,!!(this.exists&&e.id&&this.setId(e.id)&&e.ref&&(this.documentReference=e.ref,this.documentReference&&this.setValues(e.data())&&(this.createTime=e.createTime,this.updateTime=e.updateTime,this.readTime=e.readTime,this.createTime&&this.updateTime&&this.readTime)))}collectionReferenceError(e){e(`Cannot fetch the collection "${this.collection}"`)}static collectionReferenceError(e){e(`Cannot fetch the collection "${this.collection}"`)}static create(e,t){let s=this.modelName||this.name,i=null;return"string"==typeof e&&t?(s=e,i=t):e&&!t&&("string"==typeof e?s=e||s:i=e),new Promise((e,t)=>{if(this.request.models&&this.request.models[s]){const r=new this.request.models[s]({request:this.request,response:this.response,firestore:this.firestore,collection:this.collection,modelName:s,schema:this.schema});setTimeout(()=>{r.collectionReference&&!i||i&&r.setId(i)?e(r):r.collectionReferenceError(t)},0)}else t(`Cannot fetch the model "${s}"`)})}static add(e,t){return this._createAndRun((s,i,r)=>{s._idSchema?!s._idSchema.validate||s._idSchema.validate&&s._idSchema.validate(e)?s.collectionReference?(s.documentReference=s.collectionReference.doc(e),s.documentReference?!t||t&&s.setValues(t)?s.documentReference.set(s.getValuesForUpdate()).then(()=>{i(s)},e=>r(e)):r(`Cannot set values for a new model "${this.modelName}"`):r(`Cannot fetch a model "${this.modelName}"`)):s.collectionReferenceError(r):r({code:400}):r(`The Schema of the model "${this.modelName}" has no field of the type ID`)})}static find(e,t,s){return e&&t?this.findWhere(e,t,s):"string"!=typeof e||t?this.findAll():this.findById(e)}static findById(e){return this._createAndRun((t,s,i)=>{t._idSchema?!t._idSchema.validate||t._idSchema.validate&&t._idSchema.validate(e)?t.collectionReference?(t.documentReference=t.collectionReference.doc(e),t.documentReference?t.documentReference.get().then(e=>{t.setFromSnapshot(e)?s(t):i({code:404})},e=>i(e)):i(`Cannot fetch a model "${this.modelName}"`)):t.collectionReferenceError(i):i({code:400}):i(`The Schema of the model "${this.modelName}" has no field of the type ID`)})}static findWhere(e,t,s){return this._createAndRun((i,r,o)=>{const n=e.split(".")[0],a=n&&i._schema&&i._schema[n];a?s&&!a.validate||a.validate&&a.validate(s)?i.collectionReference?i.collectionReference.where(e,t,s).limit(1).get().then(e=>{if(e)if(e.size){let t=!1;e.forEach(e=>{!t&&i.setFromSnapshot(e)?(t=!0,r(i)):o({code:404})})}else o({code:404});else o(`Cannot query a model "${i.modelName}"`)},e=>o(e)):i.collectionReferenceError(o):o({code:400}):o(`The Schema of the model "${i.modelName}" has no field "${n}" definition`)})}static findAll(){return new Promise((e,t)=>{if(this.firestore){const s=this.firestore.collection(this.collection);s?s.get().then(s=>{if(s)if(s.size){const i=[];s.forEach(e=>{e&&e.exists&&i.push(this._createAndRun((t,s,i)=>{t.setFromSnapshot(e)?s(t):i({code:404})}))}),Promise.all(i).then(t=>{e(t)},e=>t(e))}else t({code:404});else t(`Cannot query a model "${this.modelName}"`)},e=>t(e)):this.collectionReferenceError(t)}else t("Cannot initiailize Firestore")})}static _createAndRun(e){return new Promise((t,s)=>{this.create().then(i=>{e.call(this,i,t,s)},e=>s(e))})}_normalizeWriteResult(e){const t=e;return this._writeResult=t,t}static _normalizeElementSchema(e,t){if(t){let s=t;return void 0===s.type?s={type:t,key:e}:(s=t).key||(s.key=e),s}return null}_normalizeSchema(){if(this._schema={},!this.schema||!Object.keys(this.schema).length)throw new Error(`The Schema of the model ${this.modelName} is empty`);for(const e in this.schema){const t=o._normalizeElementSchema(e,this.schema[e]);t&&(t.type!==r.ModelFieldType.id||this._idSchema||(this._idSchema=t),this._schema[e]=t)}if(!this._idSchema)throw new Error(`The Schema of the model ${this.modelName} has no ID field defined`)}}o.modelName="",o.request=null,o.response=null,o.firestore=null,o.collection="",o.schema={},t.Model=o}]));